---
- name: Install software on all running instances via SSM
  hosts: all
  connection: amazon.aws.aws_ssm
  become: yes
  gather_facts: true
  vars:
    ansible_aws_ssm_bucket_name: "my-ansible-s3-bucketx"
    ansible_aws_ssm_s3_addressing_style: virtual

  tasks:

    - name: Wait for apt lock to be released
      shell: |
        while fuser /var/lib/dpkg/lock >/dev/null 2>&1 ||
              fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1;
        do
          echo "Waiting for apt/dpkg lock..."
          sleep 5
        done
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Install common packages (Linux)
      package:
        name:
          - curl
          - wget
          - unzip
        state: present
      when: ansible_os_family != "Windows"

    - name: Install Apache, Java, MySQL on Debian (Ubuntu)
      package:
        name:
          - apache2
          - openjdk-17-jdk
          - mysql-server
        state: present
      when: ansible_os_family == "Debian"

    - name: Start and enable Apache
      systemd:
        name: apache2
        state: started
        enabled: true
      when: ansible_os_family == "Debian"

    - name: Start and enable MySQL
      systemd:
        name: mysql
        state: started
        enabled: true
      when: ansible_os_family == "Debian"
